<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Mermaidå›¾è¡¨ç”Ÿæˆå™¨ - è‡ªé€‚åº”ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        h2 {
            color: #3498db;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .api-key-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        label {
            font-weight: 600;
            color: #555;
        }
        
        input, textarea, button {
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-generate {
            background-color: #2ecc71;
        }
        
        .btn-generate:hover {
            background-color: #27ae60;
        }
        
        .api-status {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            display: none;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-loading {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        /* ç¼–è¾‘å™¨åŒºåŸŸæ ·å¼ */
        .editor-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .editor-container, .preview-container {
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        
        .editor-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        
        .editor-actions {
            display: flex;
            gap: 10px;
        }
        
        .code-editor {
            background-color: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            flex-grow: 1;
            overflow: auto;
            min-height: 300px;
            border: 1px solid #ddd;
        }
        
        .preview-display {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            overflow: auto;
        }
        
        .mermaid-placeholder {
            color: #7f8c8d;
            text-align: center;
        }
        
        .ai-input-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
        }
        
        .ai-input-group {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        
        .ai-input-group textarea {
            flex: 1;
            min-height: 80px;
        }
        
        .ai-input-group button {
            white-space: nowrap;
        }
        
        .api-key-list {
            margin-top: 15px;
        }
        
        .api-key-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .key-masked {
            font-family: monospace;
            letter-spacing: 1px;
        }
        
        .key-actions button {
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
        
        .btn-delete {
            background-color: #e74c3c;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .model-selector {
            margin: 15px 0;
        }
        
        .model-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .backend-status {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        
        .backend-online {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .backend-offline {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1024px) {
            .editor-section {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .editor-container, .preview-container {
                min-height: 350px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .editor-toolbar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .editor-actions {
                justify-content: space-between;
            }
            
            .ai-input-group {
                flex-direction: column;
            }
            
            .ai-input-group button {
                align-self: flex-end;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                gap: 15px;
            }
            
            .card {
                padding: 12px;
                margin-bottom: 15px;
            }
            
            .code-editor, .preview-display {
                min-height: 250px;
                padding: 10px;
            }
            
            .editor-actions {
                flex-direction: column;
                gap: 5px;
            }
            
            .editor-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI Mermaidå›¾è¡¨ç”Ÿæˆå™¨ - è‡ªé€‚åº”ç‰ˆ</h1>
        
        <!-- åç«¯çŠ¶æ€æ˜¾ç¤º -->
        <div id="backend-status" class="backend-status" style="display: none;">
            æ£€æŸ¥åç«¯è¿æ¥...
        </div>
        
        <!-- API Keyç®¡ç†åŒºåŸŸ -->
        <div class="card">
            <h2>API Key ç®¡ç†</h2>
            <div class="api-key-section">
                <div class="input-group">
                    <label for="api-key-name">API Key åç§°</label>
                    <input type="text" id="api-key-name" placeholder="è¾“å…¥API Keyåç§°ï¼Œä¾‹å¦‚ï¼šQwen-Prod">
                </div>
                
                <div class="input-group">
                    <label for="api-key-value">API Key å€¼</label>
                    <input type="text" id="api-key-value" placeholder="è¾“å…¥DashScope API Key">
                </div>
                
                <button id="save-api-key">ä¿å­˜API Key</button>
                
                <div id="api-status" class="api-status"></div>
                
                <div class="api-key-list" id="api-key-list">
                    <!-- API Keyåˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
        
        <!-- å›¾è¡¨ç¼–è¾‘å’Œé¢„è§ˆåŒºåŸŸ -->
        <div class="card">
            <h2>å›¾è¡¨ç¼–è¾‘å™¨ & é¢„è§ˆ</h2>
            
            <div class="model-selector">
                <label for="model-select">é€‰æ‹©AIæ¨¡å‹ï¼š</label>
                <select id="model-select">
                    <option value="qwen-max">Qwen-Max (æœ€å¼º)</option>
                    <option value="qwen-plus">Qwen-Plus</option>
                    <option value="qwen-turbo">Qwen-Turbo (æœ€å¿«)</option>
                    <option value="qwen-7b-chat">Qwen-7B-Chat</option>
                    <option value="qwen-14b-chat">Qwen-14B-Chat</option>
                </select>
            </div>
            
            <!-- AIè¾“å…¥åŒºåŸŸ -->
            <div class="ai-input-section">
                <div class="input-group">
                    <label for="chart-description">è‡ªç„¶è¯­è¨€æè¿°</label>
                    <div class="ai-input-group">
                        <textarea id="chart-description" placeholder="è¯·è¯¦ç»†æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾è¡¨ï¼Œä¾‹å¦‚ï¼šåˆ›å»ºä¸€ä¸ªæ˜¾ç¤ºç”¨æˆ·ä»æ³¨å†Œã€ç™»å½•åˆ°è´­ä¹°å•†å“çš„å®Œæ•´æµç¨‹å›¾ï¼ŒåŒ…å«é”™è¯¯å¤„ç†åˆ†æ”¯"></textarea>
                        <button id="generate-chart" class="btn-generate">
                            <span id="generate-text">AIç”Ÿæˆå›¾è¡¨</span>
                            <span id="generate-loading" class="loading" style="display: none;"></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="generation-status" class="api-status"></div>
            
            <!-- ç¼–è¾‘å™¨å’Œé¢„è§ˆåŒºåŸŸ -->
            <div class="editor-section">
                <div class="editor-container">
                    <div class="editor-toolbar">
                        <h3>Mermaidä»£ç ç¼–è¾‘å™¨</h3>
                        <div class="editor-actions">
                            <button id="copy-code">å¤åˆ¶ä»£ç </button>
                            <button id="clear-editor">æ¸…ç©ºç¼–è¾‘å™¨</button>
                        </div>
                    </div>
                    <div id="code-editor" class="code-editor" contenteditable="true">
// ç”Ÿæˆçš„Mermaidä»£ç å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ
// æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥åœ¨æ­¤ç¼–è¾‘ä»£ç 
                    </div>
                </div>
                
                <div class="preview-container">
                    <div class="editor-toolbar">
                        <h3>å®æ—¶é¢„è§ˆ</h3>
                        <div class="editor-actions">
                            <button id="refresh-preview">åˆ·æ–°é¢„è§ˆ</button>
                        </div>
                    </div>
                    <div id="preview-display" class="preview-display">
                        <div class="mermaid-placeholder">å›¾è¡¨é¢„è§ˆåŒºåŸŸ</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="./services/aiService.browser.js"></script>
    <script>
        // åç«¯APIåœ°å€
        const BACKEND_URL = 'http://localhost:5000';
        
        // åˆå§‹åŒ–Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'default',
            securityLevel: 'loose'
        });
        
        // æ£€æŸ¥åç«¯è¿æ¥çŠ¶æ€
        async function checkBackendStatus() {
            const statusElement = document.getElementById('backend-status');
            try {
                const response = await fetch(`${BACKEND_URL}/api/health`);
                if (response.ok) {
                    statusElement.textContent = 'âœ… åç«¯æœåŠ¡è¿æ¥æ­£å¸¸';
                    statusElement.className = 'backend-status backend-online';
                    statusElement.style.display = 'block';
                    return true;
                } else {
                    throw new Error('åç«¯æœåŠ¡å¼‚å¸¸');
                }
            } catch (error) {
                statusElement.textContent = 'âŒ åç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ';
                statusElement.className = 'backend-status backend-offline';
                statusElement.style.display = 'block';
                return false;
            }
        }
        
        // API Keyç®¡ç†åŠŸèƒ½
        document.getElementById('save-api-key').addEventListener('click', function() {
            const name = document.getElementById('api-key-name').value.trim();
            const value = document.getElementById('api-key-value').value.trim();
            const statusElement = document.getElementById('api-status');
            
            if (!name || !value) {
                showStatus('è¯·å¡«å†™API Keyåç§°å’Œå€¼', 'error');
                return;
            }
            
            if (!value.startsWith('sk-')) {
                showStatus('API Keyæ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä»¥sk-å¼€å¤´', 'error');
                return;
            }
            
            saveApiKey(name, value);
            showStatus('API Keyä¿å­˜æˆåŠŸï¼', 'success');
            document.getElementById('api-key-name').value = '';
            document.getElementById('api-key-value').value = '';
            renderApiKeyList();
        });
        
        // AIç”Ÿæˆå›¾è¡¨åŠŸèƒ½
        document.getElementById('generate-chart').addEventListener('click', async function() {
            const description = document.getElementById('chart-description').value.trim();
            const selectedModel = document.getElementById('model-select').value;
            const apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [];
            
            if (!description) {
                showGenerationStatus('è¯·è¾“å…¥å›¾è¡¨æè¿°', 'error');
                return;
            }
            
            if (apiKeys.length === 0) {
                showGenerationStatus('è¯·å…ˆæ·»åŠ API Key', 'error');
                return;
            }
            
            // æ£€æŸ¥åç«¯è¿æ¥
            const backendOnline = await checkBackendStatus();
            if (!backendOnline) {
                showGenerationStatus('åç«¯æœåŠ¡æœªè¿æ¥ï¼Œæ— æ³•ç”Ÿæˆå›¾è¡¨', 'error');
                return;
            }
            
            // ä½¿ç”¨ç¬¬ä¸€ä¸ªä¿å­˜çš„API Key
            const apiKey = apiKeys[0].value;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            setGenerateButtonLoading(true);
            showGenerationStatus('æ­£åœ¨è°ƒç”¨AIç”Ÿæˆå›¾è¡¨...', 'loading');
            
            try {
                const mermaidCode = await callBackendAPI(description, apiKey, selectedModel);
                // å°†ç”Ÿæˆçš„ä»£ç å¡«å…¥ç¼–è¾‘å™¨
                document.getElementById('code-editor').textContent = mermaidCode;
                // ç«‹å³æ¸²æŸ“é¢„è§ˆ
                renderMermaidPreview(mermaidCode);
                showGenerationStatus('å›¾è¡¨ç”ŸæˆæˆåŠŸï¼', 'success');
            } catch (error) {
                console.error('APIè°ƒç”¨é”™è¯¯:', error);
                showGenerationStatus('ç”Ÿæˆå¤±è´¥: ' + error.message, 'error');
            } finally {
                setGenerateButtonLoading(false);
            }
        });
        
        // å¤åˆ¶ä»£ç åŠŸèƒ½
        document.getElementById('copy-code').addEventListener('click', function() {
            const code = document.getElementById('code-editor').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showGenerationStatus('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }).catch(err => {
                showGenerationStatus('å¤åˆ¶å¤±è´¥: ' + err, 'error');
            });
        });
        
        // æ¸…ç©ºç¼–è¾‘å™¨åŠŸèƒ½
        document.getElementById('clear-editor').addEventListener('click', function() {
            document.getElementById('code-editor').textContent = '';
            document.getElementById('preview-display').innerHTML = '<div class="mermaid-placeholder">å›¾è¡¨é¢„è§ˆåŒºåŸŸ</div>';
            showGenerationStatus('ç¼–è¾‘å™¨å·²æ¸…ç©º', 'success');
        });
        
        // åˆ·æ–°é¢„è§ˆåŠŸèƒ½
        document.getElementById('refresh-preview').addEventListener('click', function() {
            const code = document.getElementById('code-editor').textContent;
            if (code.trim()) {
                renderMermaidPreview(code);
                showGenerationStatus('é¢„è§ˆå·²åˆ·æ–°', 'success');
            } else {
                showGenerationStatus('ç¼–è¾‘å™¨ä¸ºç©ºï¼Œæ— æ³•åˆ·æ–°é¢„è§ˆ', 'error');
            }
        });
        
        // ç¼–è¾‘å™¨å†…å®¹å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°é¢„è§ˆ
        document.getElementById('code-editor').addEventListener('input', function() {
            const code = this.textContent;
            if (code.trim()) {
                // é˜²æŠ–å¤„ç†ï¼Œé¿å…é¢‘ç¹æ¸²æŸ“
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    renderMermaidPreview(code);
                }, 1000);
            }
        });
        
        // é€šè¿‡åç«¯ä»£ç†è°ƒç”¨APIï¼ˆä¼˜å…ˆä½¿ç”¨ window.aiServiceClient.generateMermaidCodeï¼Œå¦‚æœæ¨¡å—å­˜åœ¨ï¼‰
        async function callBackendAPI(description, apiKey, model = 'qwen-max') {
            // ä¼˜å…ˆä½¿ç”¨æ³¨å…¥çš„ aiServiceClientï¼ˆåœ¨ services/aiService.browser.js ä¸­å®šä¹‰ï¼‰
            try {
                if (window.aiServiceClient && typeof window.aiServiceClient.generateMermaidCode === 'function') {
                    const baseUrl = `${BACKEND_URL}/api/generate-chart`;
                    const res = await window.aiServiceClient.generateMermaidCode({ description, apiKey, model, baseUrl });
                    return res;
                }

                // å›é€€åˆ°ç›´æ¥ fetch çš„æ–¹å¼
                const response = await fetch(`${BACKEND_URL}/api/generate-chart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        apiKey: apiKey,
                        model: model
                    })
                });

                if (!response.ok) {
                    let errorText = '';
                    try { errorText = await response.text(); } catch (e) {}
                    throw new Error(errorText || `HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (!data.code) {
                    throw new Error('æœªç”Ÿæˆæœ‰æ•ˆçš„ä»£ç ');
                }

                return data.code;

            } catch (error) {
                throw new Error(`åç«¯APIè°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function showStatus(message, type) {
            const statusElement = document.getElementById('api-status');
            statusElement.textContent = message;
            statusElement.className = `api-status status-${type}`;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }
        
        function showGenerationStatus(message, type) {
            const statusElement = document.getElementById('generation-status');
            statusElement.textContent = message;
            statusElement.className = `api-status status-${type}`;
            statusElement.style.display = 'block';
            
            if (type !== 'loading') {
                setTimeout(() => {
                    statusElement.style.display = 'none';
                }, 5000);
            }
        }
        
        function setGenerateButtonLoading(loading) {
            const button = document.getElementById('generate-chart');
            const text = document.getElementById('generate-text');
            const loadingIcon = document.getElementById('generate-loading');
            
            if (loading) {
                button.disabled = true;
                text.textContent = 'ç”Ÿæˆä¸­...';
                loadingIcon.style.display = 'inline-block';
            } else {
                button.disabled = false;
                text.textContent = 'AIç”Ÿæˆå›¾è¡¨';
                loadingIcon.style.display = 'none';
            }
        }
        
        function saveApiKey(name, value) {
            let apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [];
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåKey
            const existingIndex = apiKeys.findIndex(key => key.name === name);
            if (existingIndex !== -1) {
                apiKeys[existingIndex].value = value;
            } else {
                apiKeys.push({ name, value, id: Date.now() });
            }
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
        }
        
        function renderApiKeyList() {
            const apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [];
            const listElement = document.getElementById('api-key-list');
            
            if (apiKeys.length === 0) {
                listElement.innerHTML = '<p>æš‚æ— ä¿å­˜çš„API Key</p>';
                return;
            }
            
            listElement.innerHTML = apiKeys.map(key => `
                <div class="api-key-item">
                    <div>
                        <strong>${key.name}</strong>
                        <div class="key-masked">${maskApiKey(key.value)}</div>
                    </div>
                    <div class="key-actions">
                        <button class="btn-delete" onclick="deleteApiKey(${key.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        function maskApiKey(key) {
            if (key.length <= 8) return '*'.repeat(key.length);
            return key.substring(0, 6) + '*'.repeat(key.length - 10) + key.substring(key.length - 4);
        }
        
        function deleteApiKey(id) {
            let apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [];
            apiKeys = apiKeys.filter(key => key.id !== id);
            localStorage.setItem('apiKeys', JSON.stringify(apiKeys));
            renderApiKeyList();
        }
        
        function renderMermaidPreview(code) {
            const previewElement = document.getElementById('preview-display');
            previewElement.innerHTML = '<div class="mermaid">' + code + '</div>';
            
            // é‡æ–°åˆå§‹åŒ–Mermaidä»¥æ¸²æŸ“æ–°å›¾è¡¨
            try {
                mermaid.init(undefined, previewElement.querySelectorAll('.mermaid'));
            } catch (error) {
                console.error('Mermaidæ¸²æŸ“é”™è¯¯:', error);
                previewElement.innerHTML = '<div style="color: red; padding: 20px; text-align: center;">å›¾è¡¨æ¸²æŸ“é”™è¯¯: ' + error.message + '</div>';
            }
        }
        
        // åˆå§‹åŒ–é¡µé¢
        document.addEventListener('DOMContentLoaded', async function() {
            renderApiKeyList();
            await checkBackendStatus();
            
            // å¦‚æœæœ‰ä¿å­˜çš„API Keyï¼Œåœ¨æ§åˆ¶å°æ˜¾ç¤ºæç¤º
            const apiKeys = JSON.parse(localStorage.getItem('apiKeys')) || [];
            if (apiKeys.length > 0) {
                console.log('âœ… å·²åŠ è½½ä¿å­˜çš„API Keyï¼Œå¯ä»¥å¼€å§‹ç”Ÿæˆå›¾è¡¨');
            } else {
                console.log('ğŸ’¡ è¯·å…ˆæ·»åŠ DashScope API Key');
            }
        });
        
        // æš´éœ²å‡½æ•°åˆ°å…¨å±€ä½œç”¨åŸŸ
        window.deleteApiKey = deleteApiKey;
    </script>
</body>
</html>